let allMemos=[],tagStats=new Map,activeTag=null,currentPage=1,PAGE_SIZE=20,filteredMemos=[],memoCache={data:null,etag:null,timestamp:null};function getMemoTags(e){if(e.dataset.tags)return JSON.parse(e.dataset.tags);let t=new Set;var n=e.querySelectorAll(".tag");if(0<n.length)n.forEach(e=>{e=e.textContent.trim().replace(/^#/,"");e&&(t.add(e),e.includes("/"))&&t.add(e.split("/")[0])});else for(var a=/#([^\s#]+)/g,o=e.textContent;null!==(l=a.exec(o));){var l=l[1].trim();l&&(t.add(l),l.includes("/"))&&t.add(l.split("/")[0])}return Array.from(t)}function updateTagStats(e){tagStats.clear(),e.flat().forEach(e=>{tagStats.set(e,(tagStats.get(e)||0)+1);let t=e;for(;t.includes("/");)t=t.split("/").slice(0,-1).join("/"),tagStats.set(t,(tagStats.get(t)||0)+1)})}function renderTagList(){let r={};tagStats.forEach((n,a)=>{var o=a.split("/");if(1===o.length)r[a]?r[a].count+=n:r[a]={tag:a,count:n,children:[]};else if(2===o.length){var l=o[0];r[l]||(r[l]={tag:l,count:0,children:[]}),r[l].children.push({tag:a,count:n,children:[]})}else if(3===o.length){l=o[0];let t=o[0]+"/"+o[1],e=(r[l]||(r[l]={tag:l,count:0,children:[]}),r[l].children.find(e=>e.tag===t));e||(e={tag:t,count:0,children:[]},r[l].children.push(e)),e.children.push({tag:a,count:n})}}),filterConfig&&"asc"===filterConfig.tagListOrder?Object.values(r).sort((e,t)=>e.count-t.count):Object.values(r).sort((e,t)=>t.count-e.count);let t=`<div class="tag-item all-tag ${activeTag?"":"active"}" data-tag="">
                    全部笔记
                    <span class="count">${allMemos.length}</span>
                </div>`,n=(Object.values(r).forEach(e=>{t+=function t(e,n){let a,o=(a=1===n?"# "+e.tag:2===n?e.tag.replace(/^[^/]+\//,""):3===n?e.tag.replace(/^[^/]+\/[^/]+\//,""):e.tag,""),l=(e.children&&0<e.children.length&&(o='<span class="toggle-arrow">▶</span>'),`<div class="tag-item level-${n} ${e.tag===activeTag?"active":""}" data-tag="${e.tag}">
                        ${a}
                        <span class="count">${e.count}</span>
                        ${o}
                    </div>`);return e.children&&0<e.children.length&&(l+='<div class="tag-children" style="display: none;">',e.children.forEach(e=>{l+=t(e,n+1)}),l+="</div>"),l}(e,1)}),document.getElementById("tag-list"));n.innerHTML=t,n.addEventListener("click",e=>{var t;e.target.classList.contains("toggle-arrow")?(e.stopPropagation(),(t=(t=e.target.closest(".tag-item"))?t.nextElementSibling:null)&&t.classList.contains("tag-children")&&("none"===t.style.display?(t.style.display="block",e.target.textContent="▼"):(t.style.display="none",e.target.textContent="▶"))):(t=e.target.closest(".tag-item"))&&n.contains(t)&&(e=t.dataset.tag,filterMemosByTag(activeTag=activeTag===e?null:e),n.querySelectorAll(".tag-item").forEach(e=>{e.classList.toggle("active",e.dataset.tag===activeTag)}))})}function filterMemosByTag(t){filteredMemos=t?allMemos.filter(e=>"exclude"===filterConfig.tagFilterMode?!e.tags.includes(t):e.tags.includes(t)).map(e=>e.html):allMemos.map(e=>e.html),renderPageOptimized(1,!0),document.getElementById("content").scrollTop=0}function processContent(){var e=document.getElementById("content");var t=e.querySelector(".memos"),t=(t&&!function t(n){if(n.nodeType===Node.TEXT_NODE){var a,o=n.textContent,l=/#([^\s#]+)/g;let e=0;for(var r=document.createDocumentFragment();null!==(a=l.exec(o));){a.index>e&&r.appendChild(document.createTextNode(o.slice(e,a.index)));var i=document.createElement("span");i.className="tag",i.textContent="#"+a[1],r.appendChild(i),e=l.lastIndex}e<o.length&&r.appendChild(document.createTextNode(o.slice(e))),0<r.childNodes.length&&n.parentNode.replaceChild(r,n)}else n.nodeType!==Node.ELEMENT_NODE||n.classList.contains("tag")||Array.from(n.childNodes).forEach(e=>t(e))}(t),document.createElement("div")),n=(t.innerHTML=e.innerHTML,document.createTreeWalker(t,NodeFilter.SHOW_TEXT,null,!1));let r=/https?:\/\/[^\s<]+/g;for(var a,o=[];a=n.nextNode();)o.push(a);o.forEach(t=>{var n=t.textContent;if(r.test(n)){var a,o=document.createDocumentFragment();let e=0;for(r.lastIndex=0;a=r.exec(n);){a.index>e&&o.appendChild(document.createTextNode(n.slice(e,a.index)));var l=document.createElement("a");l.href=a[0],l.textContent=a[0],l.target="_blank",l.rel="noopener noreferrer",o.appendChild(l),e=r.lastIndex}e<n.length&&o.appendChild(document.createTextNode(n.slice(e))),t.parentNode.replaceChild(o,t)}}),e.innerHTML=t.innerHTML}function updateSEOMetadata(){if(filterConfig&&filterConfig.seo){document.title=filterConfig.seo.title||document.title;let e=document.querySelector('meta[name="description"]'),t=(e||((e=document.createElement("meta")).name="description",document.head.appendChild(e)),e.content=filterConfig.seo.description||"",document.querySelector('meta[name="keywords"]')),n=(t||((t=document.createElement("meta")).name="keywords",document.head.appendChild(t)),t.content=filterConfig.seo.keywords||"",document.querySelector('link[rel="canonical"]'));if(n||((n=document.createElement("link")).rel="canonical",document.head.appendChild(n)),n.href=filterConfig.seo.canonicalUrl||window.location.href,filterConfig.icons){let e=document.querySelector('link[rel="icon"]'),t=(e||((e=document.createElement("link")).rel="icon",document.head.appendChild(e)),e.href=filterConfig.icons.favicon,document.querySelector('link[rel="apple-touch-icon"]'));t||((t=document.createElement("link")).rel="apple-touch-icon",document.head.appendChild(t)),t.href=filterConfig.icons.appleTouchIcon,filterConfig.icons.size&&(t.sizes=filterConfig.icons.size)}}}function renderPageOptimized(e,t=!1){var n=((currentPage=e)-1)*PAGE_SIZE,e=e*PAGE_SIZE,n=filteredMemos.slice(n,e),e=document.getElementById("content");t?e.innerHTML=`<div class="memos">${n.join("")}</div>`:e.querySelector(".memos").insertAdjacentHTML("beforeend",n.join("")),"requestIdleCallback"in window?requestIdleCallback(()=>{processContent()},{timeout:1e3}):requestAnimationFrame(()=>{processContent()})}function handleScroll(){var{scrollTop:e,clientHeight:t,scrollHeight:n}=document.documentElement;n-100<=e+t&&currentPage*PAGE_SIZE<filteredMemos.length&&renderPageOptimized(currentPage+1)}function loadContent(t=!1){let n=document.getElementById("refresh-btn");n.classList.add("loading"),document.getElementById("content").innerHTML='<div class="loading">加载中...</div>',document.getElementById("tag-list").innerHTML='<div class="loading">加载中...</div>';var e=new Headers,a=(!t&&memoCache.etag&&e.append("If-None-Match",memoCache.etag),filterConfig.notesFileUrl+"?v="+filterConfig.version);fetch(a,{headers:e}).then(e=>{var t=e.headers.get("ETag");if(t&&(memoCache.etag=t),304===e.status&&memoCache.data)return console.log("使用缓存数据"),Promise.resolve(memoCache.data);if(e.ok)return e.text();throw new Error("HTTP error! status: "+e.status)}).then(e=>{"string"==typeof e&&(memoCache.data=e,memoCache.timestamp=Date.now()),processHtmlDocument((new DOMParser).parseFromString("string"==typeof e?e:memoCache.data,"text/html")),n.classList.remove("loading")}).catch(e=>{if(console.error("加载失败:",e),memoCache.data&&!t){console.log("加载失败，使用缓存数据"),processHtmlDocument((new DOMParser).parseFromString(memoCache.data,"text/html")),n.classList.remove("loading");let e=document.createElement("div");e.className="cache-notification",e.innerHTML="当前显示的是缓存数据",document.body.appendChild(e),void setTimeout(()=>e.remove(),3e3)}else document.getElementById("content").innerHTML=`
                <div style="color: #ff4444; padding: 20px; text-align: center;">
                    加载失败，请刷新页面重试<br>
                    <small style="color: #666;">${e.message}</small>
                </div>
            `,document.getElementById("tag-list").innerHTML=`
                <div style="color: #ff4444; padding: 20px; text-align: center;">
                    加载失败
                </div>
            `,n.classList.remove("loading")})}function processHtmlDocument(e){var t=e.querySelector(".memos");if(!t)throw new Error("未找到笔记内容");let l="";updateTagStats((allMemos=Array.from(t.querySelectorAll(".memo")).map(e=>{var t=e.querySelector(".time"),n=t?new Date(t.textContent.trim().match(/\d{4}-\d{1,2}-\d{1,2}/)?.[0]||0):null,a=getMemoTags(e),o=e.querySelector(".content").innerHTML,t=`
                <div class="memo" data-date="${n?n.getTime():"0"}" data-tags='${JSON.stringify(a)}'>
                    <div class="time">${t?t.textContent:""}</div>
                    <div class="content">${o}</div>
                    <div class="files">${e.querySelector(".files")?.innerHTML||""}</div>
                </div>
            `;return l+=t,{html:t,date:n,tags:a}}).filter(({date:e})=>{var t;return!filterConfig.minDate||(t=new Date(filterConfig.minDate),!e)||t<=e}).filter(({tags:e})=>!filterConfig.defaultTagFilter||(e=e.includes(filterConfig.defaultTagFilter),"exclude"===filterConfig.tagFilterMode?!e:e))).map(e=>e.tags)),renderTagList(),filteredMemos=allMemos.map(e=>e.html),renderPageOptimized(1,!0);t=e.querySelector(".user");if(t){e=t.querySelector(".name"),t=t.querySelector(".date");let n=e?e.innerText:"",a=t?t.innerText:"";document.querySelectorAll(".user").forEach(e=>{var t=e.querySelector(".name"),e=e.querySelector(".date");t&&(t.innerText=n),e&&(e.innerText=a)})}}function refreshContent(){loadContent(!0)}function init(){updateSEOMetadata(),document.getElementById("refresh-btn").addEventListener("click",refreshContent),document.getElementById("content").addEventListener("click",function(e){var n=e.target.closest(".tag");if(n&&this.contains(n)){e.stopPropagation();e=n.textContent.trim();let t=e.startsWith("#")?e.substring(1):e;filterMemosByTag(activeTag=t),document.querySelectorAll(".tag-item").forEach(e=>{e.classList.toggle("active",e.dataset.tag===t)})}}),window.addEventListener("scroll",handleScroll),setInterval(()=>{document.hidden||memoCache.timestamp&&Date.now()-memoCache.timestamp<3e5||loadContent()},3e5),document.addEventListener("visibilitychange",()=>{!document.hidden&&memoCache.timestamp&&3e5<Date.now()-memoCache.timestamp&&loadContent()}),loadContent()}document.addEventListener("DOMContentLoaded",init);